from telethon import TelegramClient, events
import asyncio
import random
import platform
import json
import torch
from transformers import GPT2LMHeadModel, GPT2Tokenizer, Trainer, TrainingArguments, DataCollatorForLanguageModeling
from datasets import Dataset
from datetime import datetime, timedelta
import os
from dotenv import load_dotenv
import sys
import signal
import asyncio

# ะะฐะณััะถะฐะตะผ ะฟะตัะตะผะตะฝะฝัะต ะธะท .env ัะฐะนะปะฐ
load_dotenv()

# ะะพะฑะฐะฒะปัะตะผ ัะตะบัััั ะดะธัะตะบัะพัะธั ะฒ ะฟััั
sys.path.append('/app')

# ะะปั ะปัััะตะน ะพะฑัะฐะฑะพัะบะธ ัะธะณะฝะฐะปะพะฒ ะฒ Docker
def handle_exit(sig, frame):
    print(f"Received exit signal {sig}, shutting down...")
    sys.exit(0)

signal.signal(signal.SIGINT, handle_exit)
signal.signal(signal.SIGTERM, handle_exit)

class DataCollector:
    """ะกะฑะพััะธะบ ะดะฐะฝะฝัั ะธะท ะบะฐะฝะฐะปะฐ"""

    def __init__(self):
        self.posts_data = []

    async def collect_posts(self, client, channel_username, limit=10000):
        """ะกะพะฑะธัะฐะตะผ ะฟะพััั ะธะท ะบะฐะฝะฐะปะฐ ะธัะฟะพะปัะทัั ะฟะตัะตะดะฐะฝะฝัะน ะบะปะธะตะฝั"""
        print(f"๐ ะกะพะฑะธัะฐั ะฟะพััั ะธะท: {channel_username}")

        channel = await client.get_entity(channel_username)
        print(f"๐ ะะฐะนะดะตะฝ ะบะฐะฝะฐะป: {channel.title}")

        # ะกะพะฑะธัะฐะตะผ ะฟะพััั
        posts = []
        total_collected = 0

        try:
            # ะัะพะฑัะตะผ ัะพะฑัะฐัั ะทะฐ ะฟะพัะปะตะดะฝะธะต 180 ะดะฝะตะน
            since_date = datetime.now() - timedelta(days=730)
            async for message in client.iter_messages(
                    channel,
                    limit=limit,
                    offset_date=since_date
            ):
                if message.text and len(message.text.strip()) > 5:  # ะฃะผะตะฝััะธะป ะดะพ 5 ัะธะผะฒะพะปะพะฒ
                    posts.append(message.text)
                    total_collected += 1
                    if total_collected % 50 == 0:
                        print(f"๐ ะกะพะฑัะฐะฝะพ {total_collected} ะฟะพััะพะฒ...")

        except Exception as e:
            print(f"โ๏ธ ะัะธะฑะบะฐ ะฟัะธ ัะฑะพัะต ั ะดะฐัะพะน: {e}")
            # ะัะปะธ ะฝะต ะฟะพะปััะธะปะพัั ั ะดะฐัะพะน, ัะพะฑะธัะฐะตะผ ะฟัะพััะพ ะฟะพ ะปะธะผะธัั
            async for message in client.iter_messages(channel, limit=limit):
                if message.text and len(message.text.strip()) > 5:
                    posts.append(message.text)
                    total_collected += 1
                    if total_collected % 50 == 0:
                        print(f"๐ ะกะพะฑัะฐะฝะพ {total_collected} ะฟะพััะพะฒ...")

        print(f"โ ะัะตะณะพ ัะพะฑัะฐะฝะพ {len(posts)} ะฟะพััะพะฒ")
        return posts


class ResponseGenerator:
    """ะะตะฝะตัะฐัะพั ะพัะฒะตัะพะฒ ะดะปั ะพะฑััะตะฝะธั"""

    def generate_responses(self, posts):
        """ะะตะฝะตัะธััะตะผ ะบััััะต ะพัะฒะตัั ะฝะฐ ะฟะพััั"""
        responses = []

        for i, post in enumerate(posts):
            post_lower = post.lower()

            # ะะตะฝะตัะฐัะธั ะพัะฒะตัะพะฒ ะฒ ััะธะปะต ะบัะฐััะพะฒะพะน ะบัะปััััั ั ัะผะพัะพะผ
            if any(word in post_lower for word in
                   ['ะฟะธะฒะพ', 'beer', 'ะฟะตะฝะฝัะน', 'ะปะฐะณะตั', 'ัะปั', 'ััะฐัั', 'ipa', 'apa', 'ะบัะฐัั']):
                response = random.choice([
                    "ะัะปะธัะฝัะน ะบัะฐัั! ะฅะผะตะปั ะฟัะพััะพ ะฑะพะผะฑะฐ! ๐บ๐ฅ",
                    "ะะธะฒะพ, ะพั ะบะพัะพัะพะณะพ ะผััะฐัะบะธ ะฟะพ ะบะพะถะต! ๐ปโจ",
                    "ะขะฐะบะพะน ัะปั ะผะพะถะฝะพ ะฟะธัั ะปะธััะฐะผะธ! ๐๐บ",
                    "ะะฐััะพััะธะน ะบัะฐัั - ััะฒััะฒัะตััั ััะบะฐ ะผะฐััะตัะฐ! ๐จ๐ป",
                    "ะะธะฒะพ, ัะฐะดะธ ะบะพัะพัะพะณะพ ััะพะธั ะถะธัั! ๐บ๐ซ",
                    "ะฅะผะตะปัะฝะฐั ัะตะตัะธั! ะะดั ะฟัะพะดะพะปะถะตะฝะธั! ๐๐ป",
                    "ะญัะพั ััะฐัั - ะฟัะพััะพ ะบะพัะผะพั! ๐๐บ",
                    "ะญัะพั IPA ะฝะฐััะพะปัะบะพ ะณะพััะบะธะน, ััะพ ะดะฐะถะต ะฟะฐัะตะฝั ะพะดะพะฑัะธะป! ๐๐บ",
                    "ะะพะฒะพััั, ะฟะพัะปะต ััะพะณะพ ััะฐััะฐ ะผะพะถะฝะพ ัะฒะธะดะตัั ะทะฒัะบ ะธ ััะปััะฐัั ัะฒะตั. ะัะพะฒะตัะธะผ? ๐๐บ",
                    "ะัะฐัั, ะพั ะบะพัะพัะพะณะพ ั ะฑะพัะพะดั ัะฐะผะพะน ะฝะฐัะธะฝะฐะตั ัะฐััะธ ัะผะตะปั! ๐งโโ๏ธ๐บ",
                    "ะญัะพ ะฝะต ะฟะธะฒะพ, ััะพ ัะผะตะปัะฝะฐั ัะตัะฐะฟะธั ะพั ะฒัะตั ะถะธะทะฝะตะฝะฝัั ะฟัะพะฑะปะตะผ. ๐๐บ",
                    "ะขะฐะบะพะต ะฟะธะฒะพ, ััะพ ะดะฐะถะต ะปะพัะพัั ะฑั ะฟะพััะป ะฝะฐ ะฝะตัะตัั ะฒ ัะฒะพะน ะฑะพะบะฐะป! ๐๐บ",
                    "ะะพัะปะต ััะพะณะพ ะฟะธะฒะฐ ะฟะพะฝะธะผะฐะตัั, ััะพ 'apa' - ััะพ ะฝะต ะพะฟะตัะฐัะบะฐ, ะฐ ะบัะธะบ ะดััะธ! ๐ฃ๏ธ๐บ",
                    "ะะตะฝะฝัะน, ะบะฐะบ ะผะพะธ ะผััะปะธ ะพ ะทะฐะฒััะฐัะฝะตะผ ะดะฝะต ะฟะพ ะฟะพะฝะตะดะตะปัะฝะธะบะฐะผ. ๐ต"
                ])
            elif any(word in post_lower for word in ['ะผะตะด', 'ะผัะด', 'ะฟัะตะป', 'ะฟััะปั', 'ะผะตะดะพะฒัั', 'ะผะธะด', 'mead']):
                response = random.choice([
                    "ะะตะดะพะฒััะฐ - ะฝะฐะฟะธัะพะบ ะฑะพะณะพะฒ! ๐ฏ๐",
                    "ะะฐััะพััะธะน ะผะธะด - ัะปะฐัะต ะฟะพัะตะปัั! ๐๐ฏ",
                    "ะัะตะปะบะธ ะฑั ะพะดะพะฑัะธะปะธ! ๐โค๏ธ",
                    "ะะตะด, ะพั ะบะพัะพัะพะณะพ ะดััะฐ ะฟะพะตั! ๐ต๐ฏ",
                    "ะะพะปะพัะพะน ะฝะฐะฟะธัะพะบ ะดะปั ะทะพะปะพััั ะปัะดะตะน! โจ๐ฏ",
                    "ะะตะดะพะฒััะฐ, ะบะพัะพัะฐั ะณัะตะตั ะดััั! ๐ฅ๐ฏ",
                    "ะะฐััะพััะฐั ะผะตะดะพะฒะฐั ะผะฐะณะธั! ๐ง๐ฏ",
                    "ะญัะฐ ะผะตะดะพะฒััะฐ ะฝะฐััะพะปัะบะพ ัะปะฐะดะบะฐั, ััะพ ั ะธะฝััะปะธะฝะฐ ัะปัะฝะบะธ ะฟะพัะตะบะปะธ! ๐ฏ๐",
                    "ะััะปั, ะบะพัะพััะต ััะพ ัะดะตะปะฐะปะธ, ะฝะฐะฒะตัะฝะพะต, ะฟะพะปััะธะปะธ ะะพะฑะตะปะตะฒัะบัั ะฟัะตะผะธั ะฟะพ ะณะฐัััะพะฝะพะผะธะธ. ๐๐",
                    "ะะพัะปะต ััะพะณะพ ะผะธะดะฐ ะฝะฐัะธะฝะฐะตัั ะฟะพะฝะธะผะฐัั ัะทัะบ ะฟััะป. ะ-ะถ-ะถ-ะถะตะปะฐั ะตัั! ๐๐ฃ๏ธ",
                    "ะัะด, ะพั ะบะพัะพัะพะณะพ ะะธะฝะฝะธ-ะัั ะฟัะพะดะฐะป ะฑั ะดััั. ะ ะตัั ะฟะพะฟัะพัะธะป ะดะพะฑะฐะฒะบะธ. ๐ป๐ธ",
                    "ะญัะพ ะฝะต ะพะฟััะฝะตะฝะธะต, ััะพ ัะพััะพัะฝะธะต 'ะผะตะดะพะฒะพะณะพ ะฑะปะฐะถะตะฝััะฒะฐ'. ะััะพัะพะถะฝะพ, ะฒัะทัะฒะฐะตั ะฟัะธะฒัะบะฐะฝะธะต! ๐ฏ๐ต",
                    "ะะฐััะพััะธะน ะผะธะด - ะบะพะณะดะฐ ะฟะพะฝะธะผะฐะตัั, ััะพ 'ะฟัะตะปะธะฝัะน ัััะด' - ััะพ ะฝะต ะผะตัะฐัะพัะฐ! ๐๐ช"
                ])
            elif any(word in post_lower for word in ['ัะธะดั', 'cider', 'ัะฑะปะพัะฝ', 'ะณััั']):
                response = random.choice([
                    "ะกะธะดั - ะพัะตะฝั ะฒ ะฑะพะบะฐะปะต! ๐๐",
                    "ะฏะฑะปะพัะฝะฐั ัะฒะตะถะตััั - ััะพ ะผะพะถะตั ะฑััั ะปัััะต! ๐โจ",
                    "ะกะธะดั, ะพั ะบะพัะพัะพะณะพ ัะตะบะธ ัะพะทะพะฒะตัั! ๐๐",
                    "ะะฐััะพััะธะน ัะฑะปะพัะฝัะน ะฒะพััะพัะณ! ๐๐",
                    "ะกะธะดั ะดะปั ะธััะธะฝะฝัั ัะตะฝะธัะตะปะตะน! ๐๐",
                    "ะะฐัะฝะตั ัะฑะปะพะบะฐะผะธ ะธ ััะฐัััะตะผ! ๐๐ซ",
                    "ะัะฒะตะถะฐััะธะน ะบะฐะบ ัััะตะฝะฝัั ัะพัะฐ! ๐๐",
                    "ะญัะพั ัะธะดั ะฝะฐััะพะปัะบะพ ัะฑะปะพัะฝัะน, ััะพ ะัััะพะฝ ะฟะพะด ะฝะธะผ ะฝะต ัะพะปัะบะพ ัะฑะปะพะบะพ ะฟะพะนะผะฐะป, ะฝะพ ะธ ัะตะพัะธั ะพัะฝะพัะธัะตะปัะฝะพััะธ ะดะพะฟะธะป! ๐๐ญ",
                    "ะกะธะดั, ะพั ะบะพัะพัะพะณะพ ะดะฐะถะต ะัะตะฝะฝะธ ะกะผะธั ะฟะพะบัะฐัะฝะตะปะฐ ะฑั! ๐๐ณ",
                    "ะะพัะปะต ััะพะณะพ ัะธะดัะฐ ะฝะฐัะธะฝะฐะตัั ะฒะธะดะตัั core-ะฟะปะพะดั, ะฐ ะฝะต ะพะฑััะฝัะต ัะฑะปะพะบะธ! ๐๐ป",
                    "ะัะฒะตะถะฐััะธะน, ะบะฐะบ ะฟะพัะตัะธะฝะฐ ัะฝะตะถะฝะพะน ะบะพัะพะปะตะฒั. ะะพ ะฟัะธััะฝะตะต! โ๏ธ๐",
                    "ะัััะตะฒัะน ัะธะดั? ะญัะพ ะบะพะณะดะฐ ัั ัะฐะบะพะน ัะปะตะณะฐะฝัะฝัะน, ััะพ ะดะฐะถะต ะฟััะฝะตะตัั ั ะฐะบัะตะฝัะพะผ. ๐๐ฉ"
                ])
            elif any(word in post_lower for word in ['ะฒะธะฝะพ', 'ะฒะธะฝะพะณัะฐะด', 'ะฒะธะฝะฝ', 'ัะฐะผะฟะฐะฝัะบ', 'ะธะณัะธััะพะต']):
                response = random.choice([
                    "ะะธะฝะพ, ะพั ะบะพัะพัะพะณะพ ะบััะถะธััั ะณะพะปะพะฒะฐ! ๐ท๐ต",
                    "ะัะบะตั ะฟัะพััะพ ะฑะพะถะตััะฒะตะฝะฝัะน! ๐๐ท",
                    "ะะธะฝะพ ะดะปั ัะพะผะฐะฝัะธัะตัะบะธั ะฒะตัะตัะพะฒ! ๐น๐ท",
                    "ะะฐััะพััะฐั ะฒะธะฝะพะณัะฐะดะฝะฐั ะฟะพัะทะธั! ๐๐",
                    "ะะณัะธััะพะต, ะบะฐะบ ะฝะพะฒะพะณะพะดะฝัั ะฝะพัั! ๐๐ฅ",
                    "ะะธะฝะพ, ะบะพัะพัะพะต ัะฐััะบะฐะทัะฒะฐะตั ะธััะพัะธั! ๐ฃ๏ธ๐ท",
                    "ะะพะบะฐะป ะฒะธะฝะฐ - ะปะตะบะฐัััะฒะพ ะพั ะฒัะตะณะพ! ๐๐ท",
                    "ะัะบะตั ั ะฒะธะฝะฐ ัะฐะบะพะน ัะปะพะถะฝัะน, ััะพ ะดะปั ะตะณะพ ะพะฟะธัะฐะฝะธั ะฝัะถะฝะพ ะฒัััะตะต ัะธะปะพะปะพะณะธัะตัะบะพะต ะพะฑัะฐะทะพะฒะฐะฝะธะต! ๐ท๐",
                    "ะญัะพ ะฒะธะฝะพ ะฝะฐััะพะปัะบะพ ะฒัะดะตัะถะฐะฝะฝะพะต, ััะพ ะพะฝะพ ะฟะพะผะฝะธั, ะบะฐะบ ะะฐะฟะพะปะตะพะฝ ะฑัะป ะตัั ะปะตะนัะตะฝะฐะฝัะพะผ! ๐ท๐ด",
                    "ะะพัะปะต ััะพะณะพ ัะฐะผะฟะฐะฝัะบะพะณะพ ะฟะพะฝะธะผะฐะตัั, ััะพ 'ะธะณัะธััะพะต' - ััะพ ะฝะต ะฟัะพ ะฒะธะฝะพ, ะฐ ะฟัะพ ัะฒะพั ะฝะฐัััะพะตะฝะธะต! ๐ฅโจ",
                    "ะะธะฝะพ, ะพั ะบะพัะพัะพะณะพ ะดะฐะถะต ัะพะผะตะปัะต ะทะฐะฟะปะฐะบะฐะป ะธ ะฟะพะทะฒะพะฝะธะป ะผะฐะผะต. ๐ท๐ญ๐",
                    "ะขะฐะฝะฝะธะฝั ัะฐะบะธะต ะฑะฐััะฐัะฝัะต, ััะพ ัะพัะตััั ะฟะพัะธัั ะธะท ะฝะธั ะฟะธะดะถะฐะบ. ๐ท๐งฅ"
                ])
            elif any(word in post_lower for word in ['ะฐะปะบะพะณะพะป', 'ะฒะธัะบะธ', 'ะฒะพะดะบะฐ', 'ะบะพะฝััะบ', 'ัะพะผ', 'ะดะถะธะฝ', 'ัะตะบะธะปะฐ']):
                response = random.choice([
                    "ะัะตะฟะบะธะน ะฝะฐะฟะธัะพะบ ะดะปั ัะธะปัะฝัั ะดััะพะผ! ๐ช๐ฅ",
                    "ะะปะบะพะณะพะปั, ะบะพัะพััะน ะปะตัะธั ะดััั! โค๏ธ๐ฉน",
                    "ะะฐ ัะฐะบะพะผ ะธ ะณะพัั ัะฒะตัะฝะตัั! ๐๏ธ๐ฅ",
                    "ะะฐะฟะธัะพะบ ะฝะฐััะพััะธั ัะตะฝะธัะตะปะตะน! ๐๐ฅ",
                    "ะัะตะฟะพััั, ะบะพัะพัะฐั ัะพะณัะตะตั ะธะทะฝัััะธ! ๐ฅ๐ฅ",
                    "ะะปะบะพะณะพะปั - ะธัะบััััะฒะพ ะฒ ะถะธะดะบะพะผ ะฒะธะดะต! ๐จ๐ฅ",
                    "ะะปั ัะผะตะปัั ะธ ัะตัะธัะตะปัะฝัั! ๐ฅท๐ฅ",
                    "ะญัะพั ะฒะธัะบะธ ะฝะฐััะพะปัะบะพ ะฒัะดะตัะถะฐะฝะฝัะน, ััะพ ั ะฝะตะณะพ ัะถะต ะตััั ะธะฟะพัะตะบะฐ ะธ ะดะฒะฐ ัะตะฑัะฝะบะฐ ะฒ ะบะพะปะปะตะดะถะต. ๐ฅ๐",
                    "ะะพัะปะต ััะพะณะพ ัะพะผะฐ ะฝะฐัะธะฝะฐะตัั ะฟะพะฝะธะผะฐัั, ะพ ััะผ ะฟะตะป ะฟะธัะฐั ะฒ ัะพะน ะฟะตัะฝะต. ะะพ-ัะพ-ัะพ ะธ ะฑัััะปะบะฐ... ๐ดโโ๏ธ๐ฅ",
                    "ะะพะดะบะฐ ะฝะฐััะพะปัะบะพ ัะธััะฐั, ััะพ ัะตัะตะท ะฝะตั ะผะพะถะฝะพ ัะฐััะผะฐััะธะฒะฐัั ัะฒะพะธ ะถะธะทะฝะตะฝะฝัะต ะพัะธะฑะบะธ. ๐ฅ๐",
                    "ะะถะธะฝ, ะพั ะบะพัะพัะพะณะพ ะดะฐะถะต ะฐะฝะณะปะธะนัะบะฐั ะบะพัะพะปะตะฒะฐ ะผะพะถะตั ัะดะตะปะฐัั 'ัััั ะฟะพะฑะตัะธ'! ๐ฅ๐",
                    "ะขะตะบะธะปะฐ, ะฟะพัะปะต ะบะพัะพัะพะน ะฟัะพััะฟะฐะตัััั ะฝะต ัะพะปัะบะพ ั ะบะฐะบัััะพะผ, ะฝะพ ะธ ั ะผะตะบัะธะบะฐะฝัะบะธะผ ะฟะฐัะฟะพััะพะผ! ๐ต๐ฅ"
                ])
            elif any(word in post_lower for word in ['ะผัะทัะบ', 'ะดะธะดะถะตะน', 'ะบะพะฝัะตัั', 'ัะตััะธะฒะฐะป', 'ัะฐะฝั', 'live']):
                response = random.choice([
                    "ะัะทัะบะฐ - ะดััะฐ ะปัะฑะพะน ะฒะตัะตัะธะฝะบะธ! ๐ต๐",
                    "ะะธะดะถะตะน ะฟัะพััะพ ะพะณะพะฝั! ๐ฅ๐ง",
                    "ะคะตััะธะฒะฐะปั ะผะตััั! ะะดั ะฝะต ะดะพะถะดััั! ๐คฉ๐ช",
                    "ะขะฐะฝัั ะดะพ ัะฟะฐะดั! ๐๐บ",
                    "ะัะทัะบะฐ, ะบะพัะพัะฐั ะฑัะตั ะฟััะผะพ ะฒ ัะตัะดัะต! ๐๐ต",
                    "ะะพะฝัะตัั, ะบะพัะพััะน ะทะฐะฟะพะผะฝะธััั ะฝะฐะฒัะตะณะดะฐ! ๐๐ค",
                    "ะะฒััะธั ะปัััะต, ัะตะผ ะฒ ะผะตััะฐั! ๐ถโจ",
                    "ะะฐั-ะฑะพัะบะฐ ัะฐะบะฐั ะผะพัะฝะฐั, ััะพ ั ัะพัะตะดะตะน ะฟะพััะดะฐ ัะฐะผะฐ ัะฐะฝััะตั! ๐ฅ๐",
                    "ะะธะดะถะตะน ัะฒะพะดะธั ัะฐะบ, ััะพ ะดะฐะถะต ะฟััะฝัะน ะดัะดั ะะฐัั ั ัััะฝะธะบะตัะฐ ะฝะฐัะธะฝะฐะตั ัะฐะทะฑะธัะฐัััั ะฒ ะถะฐะฝัะฐั! ๐ง๐ค",
                    "ะคะตััะธะฒะฐะปั, ะฝะฐ ะบะพัะพัะพะผ ะดะพะถะดั - ััะพ ะฝะต ะฟะพะณะพะดะฐ, ะฐ ะฟะตัะบัััะธะพะฝะฝัะน ะธะฝััััะผะตะฝั! ๐ง๏ธ๐ต",
                    "ะัะทัะบะฐ ะฝะฐััะพะปัะบะพ ะณัะพะผะบะฐั, ััะพ Shazam ัะดะฐะปัั ะธ ะฟัะพััะพ ะฝะฐะฟะธัะฐะป 'ะดะฐ, ััะพ ะพะณะพะฝั'! ๐ฅ๐ฑ",
                    "ะขะฐะฝัั ัะฐะบะธะต ะทะฐะถะธะณะฐัะตะปัะฝัะต, ััะพ ะฟะพะถะฐัะฝะฐั ัะปัะถะฑะฐ ัะถะต ะฝะฐะณะพัะพะฒะต! ๐๐"
                ])
            elif any(word in post_lower for word in ['ะตะดะฐ', 'ะฑััะณะตั', 'ะทะฐะบััะบ', 'ะณะฐัััะพะฝะพะผ', 'ะบััะฝ', 'ัะตัะตะฟั']):
                response = random.choice([
                    "ะะดะฐ, ะพั ะบะพัะพัะพะน ัะปัะฝะบะธ ัะตะบัั! ๐คค๐",
                    "ะะฐัััะพะฝะพะผะธัะตัะบะธะน ะพัะณะฐะทะผ! ๐ฝ๏ธ๐",
                    "ะััะณะตั - ะบะฐะบ ะพะฑัััะธะต ะดะปั ะถะตะปัะดะบะฐ! ๐ค๐",
                    "ะะฐะบััะบะฐ, ัะฐะดะธ ะบะพัะพัะพะน ััะพะธั ะฟะธัั! ๐ป๐ฅจ",
                    "ะะบััะฝะพ ะดะพ ัะปะตะท! ๐ญ๐",
                    "ะะดะฐ, ะบะพัะพัะฐั ะณัะตะตั ะดััั! ๐ฅ๐ฒ",
                    "ะะฐััะพััะตะต ะบัะปะธะฝะฐัะฝะพะต ะธัะบััััะฒะพ! ๐จ๐ณ๐จ",
                    "ะััะณะตั ะฝะฐััะพะปัะบะพ ัะพัะฝัะน, ััะพ ะดะปั ะตะณะพ ะฟะพะตะดะฐะฝะธั ะฝัะถะฝะพ ะฟะพะดะฟะธัััั ะดะพะณะพะฒะพั ั ะฟัะฐัะตัะฝะพะน! ๐๐ฟ",
                    "ะะฐะบััะบะฐ, ัะฐะดะธ ะบะพัะพัะพะน ะผะพะถะฝะพ ะฟัะพััะธัั ะธะทะผะตะฝั. ะั, ะฟะพััะธ. ๐ฅจ๐",
                    "ะะฐัััะพะฝะพะผะธัะตัะบะธะน ัะตะดะตะฒั, ะฟะพัะปะต ะบะพัะพัะพะณะพ ัะพัะตััั ะฐะฟะปะพะดะธัะพะฒะฐัั ะฟะพะฒะฐัั ััะพั. ะ ะฟะปะฐะบะฐัั. ๐ฝ๏ธ๐๐ญ",
                    "ะะดะฐ, ะพั ะบะพัะพัะพะน ะธะฝััะฐะณัะฐะผ ะฟะปะฐัะตั ะพั ััะฐัััั, ะฐ ะดะธะตัะพะปะพะณ - ะพั ะณะพัั. ๐ธ๐๐ญ",
                    "ะญัะพ ะฝะต ะทะฐะบััะบะฐ, ััะพ ัะฟะฐัะฐัะตะปัะฝัะน ะบััะณ ะดะปั ัะฒะพะตะณะพ ะฟะพัะผะตะปัั! ๐ฅจ"
                ])
            elif any(word in post_lower for word in ['ะฒะตัะตัะธะฝะบ', 'ัััะพะฒะบ', 'party', 'ะฝะพัั', 'ะบะปัะฑ']):
                response = random.choice([
                    "ะะตัะตัะธะฝะบะฐ ะผะตััั! ๐๐",
                    "ะะพัั, ะบะพัะพััั ะฝะต ะทะฐะฑัะดะตัั! ๐โจ",
                    "ะขััะพะฒะบะฐ ะพะณะพะฝั! ะะฐะปั, ััะพ ั ะฝะต ั ะฒะฐะผะธ! ๐ฅ๐ข",
                    "Party like there's no tomorrow! ๐๐บ",
                    "ะะปัะฑ, ะณะดะต ัะพะถะดะฐัััั ะปะตะณะตะฝะดั! ๐๐ช",
                    "ะะตัะตัะธะฝะบะฐ, ะพั ะบะพัะพัะพะน ะฑะพะปะธั ะฒัะต, ะบัะพะผะต ะดััะธ! ๐ช๐",
                    "ะะพัั ะฑะตะทัะผะธั ะธ ะฒะตัะตะปัั! ๐๐",
                    "ะะตัะตัะธะฝะบะฐ ะฝะฐััะพะปัะบะพ ะบัััะฐั, ััะพ ะดะฐะถะต ะพััะฐะฝะฝะธะบ ั ะฒัะพะดะฐ ัะฐะฝััะตั ะปัััะต ะผะตะฝั! ๐๐บ",
                    "ะขััะพะฒะบะฐ, ะฟะพัะปะต ะบะพัะพัะพะน 'ะฟัะธะฒะตั, ั ัะฒะพะน ะดะธะฒะฐะฝ' ะทะฒััะธั ะบะฐะบ ะฟัะตะดะปะพะถะตะฝะธะต ััะบะธ ะธ ัะตัะดัะฐ! ๐๏ธ๐",
                    "ะะพัั, ะบะพัะพัะฐั ะทะฐะบะพะฝัะธะปะฐัั ัะฐะผ, ะณะดะต ะฝะฐัะธะฝะฐะตััั ะปะตะณะตะฝะดะฐ. ะ ะฟะพะธัะบ ะบะปััะตะน. ๐๐๏ธ",
                    "Party level: 'ะทะฐะฒััะฐ ัััะพะผ ะฑัะดั ะถะฐะปะตัั, ะฝะพ ัะตะนัะฐั - ะะะข!' ๐ช๐",
                    "ะะปัะฑ, ะฒ ะบะพัะพัะพะผ ะดะฐะถะต ะปะตะด ะฒ ััะฐะบะฐะฝะต ัะฐะฝััะตั ะปัััะต ะผะตะฝั. ะะพ ั ััะฐัะฐััั! ๐ง๐"
                ])
            elif any(word in post_lower for word in ['ัะพะทัะณััั', 'ะบะพะฝะบััั', 'ะฟะพะดะฐัะพะบ', 'ะฟัะธะท', 'ะฒัะธะณั']):
                response = random.choice([
                    "ะะพะทัะณััั - ะผะตััะฐ ัะฑัะฒะฐะตััั! ๐โจ",
                    "ะฅะพัั ะฒัะธะณัะฐัั ััะพั ะฟัะธะท! ๐๐ฏ",
                    "ะะพะฝะบััั, ัะฐะดะธ ะบะพัะพัะพะณะพ ััะพะธั ะถะธัั! ๐โค๏ธ",
                    "ะะพะดะฐัะพะบ ะผะตััั! ะฅะพัั ัะฐะบะพะน ะถะต! ๐คฉ๐",
                    "ะฃะดะฐัะฐ, ัะปัะฑะฝะธัั ะผะฝะต! ๐๐",
                    "ะะพะทัะณััั, ะบะพัะพััะน ะธะทะผะตะฝะธั ะถะธะทะฝั! ๐๐",
                    "ะัะธะท, ัะฐะดะธ ะบะพัะพัะพะณะพ ั ะณะพัะพะฒ ะฝะฐ ะฒัะต! ๐ช๐ฏ",
                    "ะฅะพัั ััะพั ะฟัะธะท ัะฐะบ ัะธะปัะฝะพ, ััะพ ะณะพัะพะฒ ะฟะพะดะฟะธัะฐัััั ะฝะฐ ัะฐัััะปะบั ะดะฐะถะต ะพั ัััะธ ะะปะฐัะธ! ๐ง๐",
                    "ะะพะทัะณััั, ัะฐะดะธ ะบะพัะพัะพะณะพ ั ัะพะทะดะฐะป 15 ัะตะนะบะพะฒัั ะฐะบะบะฐัะฝัะพะฒ. ะจััั. ะะปะธ ะฝะตั? ๐๐ฏ",
                    "ะญัะพั ะฟะพะดะฐัะพะบ ะฝัะถะตะฝ ะผะฝะต ะฑะพะปััะต, ัะตะผ ััะฑะฐะบั - ะฝะพะฒะฐั ัะดะพัะบะฐ. ะะฐะดะฝะพ, ะผะพะถะตั ะฝะต ัะพะฒัะตะผ. ๐ฃ๐",
                    "ะัะปะธ ั ะฒัะธะณัะฐั, ะพะฑะตัะฐั ะดะตะปะธัััั... ัะพัะพะณัะฐัะธัะผะธ ัะพะณะพ, ะบะฐะบ ะธะผ ะฟะพะปัะทัััั! ๐คณ๐",
                    "ะฃะดะฐัะฐ, ะฑัะดั ะบะพ ะผะฝะต ะฑะปะฐะณะพัะบะปะพะฝะฝะฐ, ะบะฐะบ ะบะพั ะบ ัะพะผั, ั ะบะพะณะพ ะฒะบััะฝััะบะฐ! ๐๐"
                ])
            elif any(word in post_lower for word in ['ะดะตะณัััะฐั', 'ะฟัะพะฑ', 'ะฒะบัั', 'ะฐัะพะผะฐั', 'ะฑัะบะตั']):
                response = random.choice([
                    "ะะตะณัััะฐัะธั - ะฟัะฐะทะดะฝะธะบ ะดะปั ัะตัะตะฟัะพัะพะฒ! ๐๐",
                    "ะะบัั, ะพั ะบะพัะพัะพะณะพ ะผััะฐัะบะธ! ๐ฅถ๐",
                    "ะัะพะผะฐั, ะบะพัะพััะน ัะฒะพะดะธั ั ัะผะฐ! ๐คฏ๐",
                    "ะัะบะตั, ะดะพััะพะนะฝัะน ะบะพัะพะปะตะน! ๐๐ท",
                    "ะะตะณัััะฐัะธั, ะบะพัะพัะฐั ะพัะบััะฒะฐะตั ะฝะพะฒัะต ะณะพัะธะทะพะฝัั! ๐๐บ",
                    "ะะบััะพะฒะพะน ะฒะทััะฒ! ๐ฅ๐",
                    "ะะฐััะพััะตะต ะฝะฐัะปะฐะถะดะตะฝะธะต ะดะปั ะณััะผะฐะฝะฐ! ๐๐ฝ๏ธ",
                    "ะะตะณัััะฐัะธั, ะฟะพัะปะต ะบะพัะพัะพะน ะผะพะน ัะทัะบ ะฟะพะปััะธะป ะะพะฑะตะปะตะฒัะบัั ะฟัะตะผะธั ะฟะพ ะฒะบััะพะฒะตะดะตะฝะธั! ๐๐",
                    "ะัะพะผะฐั ัะฐะบะพะน ัะปะพะถะฝัะน, ััะพ ะดะปั ะตะณะพ ะพะฟะธัะฐะฝะธั ะฝะต ัะฒะฐัะธั ะพะดะฝะพะณะพ ะฝะพัะฐ! ๐๐",
                    "ะะพัะปะต ััะพะน ะฟัะพะฑั ะฟะพะฝะธะผะฐะตัั, ััะพ ะดะพ ััะพะณะพ ัั ะฝะต ะถะธะป, ะฐ ะฟัะพััะพ ะถะตะฒะฐะป! ๐ฎ๐ท",
                    "ะะบััะพะฒัะต ัะตัะตะฟัะพัั ัะฐะฝัััั ะปะฐะผะฑะฐะดั, ะฐ ะฝะพั - ัะฐะฝะณะพ! ๐๐๐บ",
                    "ะัะบะตั ะฝะฐััะพะปัะบะพ ะธะทััะบะฐะฝะฝัะน, ััะพ ัะพัะตััั ะธะทะฒะธะฝะธัััั ะฟะตัะตะด ัะฒะพะธะผ ะฟัะพัะปัะผ ะฐะปะบะพะณะพะปัะฝัะผ ะพะฟััะพะผ. ๐ท๐"
                ])
            else:
                response = random.choice([
                    "ะัะปะธัะฝัะน ะฟะพัั! ะะดั ะฟัะพะดะพะปะถะตะฝะธั! ๐ฅ๐",
                    "ะะพะฝัะตะฝั, ะบะพัะพััะน ะทะฐััะถะฐะตั ัะฝะตัะณะธะตะน! โก๐",
                    "ะะพัะปะต ัะฐะบะพะณะพ ัะพัะตััั ัะฒะพัะธัั! ๐จโจ",
                    "ะญัะพั ะฟะพัั - pure gold! ๐๐",
                    "ะัะดะฐะตัะต ะบะฐะบ ะฒัะตะณะดะฐ ะฝะฐ ะฒััะพัะต! ๐๐ซ",
                    "ะะพะฝัะตะฝั ััะพะฒะฝั ะฑะพะณะพะฒ! ๐๐",
                    "ะะพัั, ะบะพัะพััะน ะดะตะปะฐะตั ะดะตะฝั ะปัััะต! โ๏ธโค๏ธ",
                    "ะะฝัะพัะผะฐัะธั, ัะฐะดะธ ะบะพัะพัะพะน ััะพะธั ะถะธัั! ๐ช๐",
                    "ะะพะผะฑะธัะตัะบะธะน ะบะพะฝัะตะฝั! ๐ฃ๐ฅ",
                    "ะะฐััะพััะตะต ะธัะบััััะฒะพ ะฟะพััะธะฝะณะฐ! ๐ญ๐ฑ",
                    "ะญัะพั ะฟะพัั ะฝะฐััะพะปัะบะพ ัะพัะพั, ััะพ ั ะฟัะพััะธะป ะตะผั ะดะฐะถะต ะพััััััะฒะธะต ะฐะปะบะพะณะพะปั ะฒ ะบะฐะดัะต! ๐โค๏ธ",
                    "ะะพะฝัะตะฝั, ะพั ะบะพัะพัะพะณะพ ั ะฐะปะณะพัะธัะผะฐ ะปะตะฝัะฐ ะฟัะพัะธั ะดะพะฑะฐะฒะบะธ! ๐ค๐ฝ๏ธ",
                    "ะะพัะปะต ัะฐะบะพะณะพ ะฟะพััะฐ ัะพัะตััั ัะฒะพัะธัั, ะปัะฑะธัั ะธ ะทะฐะบะฐะทัะฒะฐัั ะฟะธััั. ะะดะฝะพะฒัะตะผะตะฝะฝะพ! ๐จโค๏ธ๐",
                    "ะญัะพ ะฝะต ะฟะพัั, ััะพ ะดััะพะฒะฝะฐั ัะบัะตะฟะบะฐ ะดะปั ะผะพะตะน ะปะตะฝัั! ๐โจ",
                    "ะะฝัะพัะผะฐัะธั, ะบะพัะพัะฐั ะณัะตะตั ะดััั ะปัััะต, ัะตะผ ะณะปะธะฝัะฒะตะนะฝ ะฒ ะดะตะบะฐะฑัะต! ๐ฅ๐",
                    "ะะพะผะฑะธัะตัะบะธะน ะบะพะฝัะตะฝั! ะะฐะถะต ัะฟะฐะผ-ะฑะพัั ััะฐะฒัั ะปะฐะนะบะธ! ๐ฃ๐ค",
                    "ะะพัั ััะพะฒะฝั 'ั ััะพ ะฟะพะบะฐะถั ัะฒะพะธะผ ะฑัะดััะธะผ ะดะตััะผ ะบะฐะบ ะฟัะธะผะตั ะบะฐัะตััะฒะตะฝะฝะพะณะพ ะบะพะฝัะตะฝัะฐ'! ๐ถ๐ฑ",
                    "ะญัะพั ะบะพะฝัะตะฝั ััะพะธั ัะพะณะพ, ััะพะฑั ะทะฐ ะฝะตะณะพ ะฟะปะฐัะธัั. ะะพ ั, ะบะพะฝะตัะฝะพ, ะฑะตัะฟะปะฐัะฝะพ ะฟะพััะตะฑะปั. ๐๐"
                ])

            responses.append({"post": post, "response": response})
            if (i + 1) % 20 == 0:
                print(f"๐ฏ ะกะณะตะฝะตัะธัะพะฒะฐะฝะพ {i + 1} ะพัะฒะตัะพะฒ...")

        print(f"โ ะัะตะณะพ ัะณะตะฝะตัะธัะพะฒะฐะฝะพ {len(responses)} ะพัะฒะตัะพะฒ")
        return responses


class SimpleModelTrainer:
    """ะฃะฟัะพัะตะฝะฝัะน ััะตะฝะตั ะผะพะดะตะปะธ"""

    def __init__(self, base_model="sberbank-ai/rugpt3small_based_on_gpt2"):
        self.tokenizer = GPT2Tokenizer.from_pretrained(base_model)
        self.model = GPT2LMHeadModel.from_pretrained(base_model)

        # ะฃััะฐะฝะฐะฒะปะธะฒะฐะตะผ pad_token
        if self.tokenizer.pad_token is None:
            self.tokenizer.pad_token = self.tokenizer.eos_token

    def prepare_training_data(self, posts_responses):
        """ะะพะดะณะพัะพะฒะบะฐ ะดะฐะฝะฝัั ะดะปั ะพะฑััะตะฝะธั"""
        training_texts = []

        for item in posts_responses:
            # ะคะพัะผะธััะตะผ ัะตะบัั ะดะปั ะพะฑััะตะฝะธั
            text = f"POST: {item['post']} RESPONSE: {item['response']}{self.tokenizer.eos_token}"
            training_texts.append(text)

        return training_texts

    def train(self, training_texts, output_dir="./my_trained_model"):
        """ะะฑััะตะฝะธะต ะผะพะดะตะปะธ"""
        print(f"๐ ะะพะดะณะพัะพะฒะบะฐ {len(training_texts)} ะฟัะธะผะตัะพะฒ ะดะปั ะพะฑััะตะฝะธั...")

        # ะกะพะทะดะฐะตะผ ะดะฐัะฐัะตั
        dataset = Dataset.from_dict({"text": training_texts})

        # ะขะพะบะตะฝะธะทะธััะตะผ
        def tokenize_function(examples):
            return self.tokenizer(
                examples["text"],
                truncation=True,
                padding=False,
                max_length=128,
                return_tensors=None
            )

        tokenized_dataset = dataset.map(tokenize_function, batched=True)

        # Data collator
        data_collator = DataCollatorForLanguageModeling(
            tokenizer=self.tokenizer,
            mlm=False,
        )

        # ะฃะฟัะพัะตะฝะฝัะต ะฐัะณัะผะตะฝัั ะพะฑััะตะฝะธั
        training_args = TrainingArguments(
            output_dir=output_dir,
            overwrite_output_dir=True,
            num_train_epochs=3,
            per_device_train_batch_size=2,
            save_steps=10000,
            save_total_limit=2,
            logging_steps=50,
            learning_rate=5e-5,
            weight_decay=0.01,
            warmup_steps=100,
        )

        trainer = Trainer(
            model=self.model,
            args=training_args,
            train_dataset=tokenized_dataset,
            data_collator=data_collator,
            tokenizer=self.tokenizer,
        )

        print("๐ ะะฐัะธะฝะฐั ะพะฑััะตะฝะธะต ะผะพะดะตะปะธ...")
        trainer.train()

        # ะกะพััะฐะฝัะตะผ ะผะพะดะตะปั
        trainer.save_model()
        self.tokenizer.save_pretrained(output_dir)
        print(f"โ ะะพะดะตะปั ะพะฑััะตะฝะฐ ะธ ัะพััะฐะฝะตะฝะฐ ะฒ {output_dir}")


async def create_client(session_name):
    """ะกะพะทะดะฐะตั ะธ ะฒะพะทะฒัะฐัะฐะตั ะบะปะธะตะฝั Telegram"""
    API_ID = int(os.getenv('API_ID'))
    API_HASH = os.getenv('API_HASH')
    PHONE = os.getenv('PHONE')

    client = TelegramClient(
        session=session_name,
        api_id=API_ID,
        api_hash=API_HASH,
        device_model=f'PC-{platform.system()}',
        system_version=platform.release(),
        app_version='4.0.0',
        system_lang_code='ru',
        lang_code='ru'
    )

    await client.start(phone=PHONE)
    print("โ ะะฒัะพัะธะทะฐัะธั ััะฟะตัะฝะฐ!")
    return client


# ะัะฝะพะฒะฝะพะน ะฟัะพัะตัั ัะฑะพัะฐ ะธ ะพะฑััะตะฝะธั
async def main():
    """ะกะฑะพั ะดะฐะฝะฝัั ะธ ะพะฑััะตะฝะธะต ะผะพะดะตะปะธ"""
    CHANNEL = '@stepiveter'

    # 1. ะกะพะทะดะฐะตะผ ะบะปะธะตะฝั ะธ ะฐะฒัะพัะธะทัะตะผัั
    print("๐ ะญัะฐะฟ 1: ะกะพะทะดะฐะฝะธะต ะบะปะธะตะฝัะฐ...")
    client = await create_client('data_collector_session')

    # 2. ะกะพะฑะธัะฐะตะผ ะดะฐะฝะฝัะต
    print("๐ ะญัะฐะฟ 2: ะกะฑะพั ะดะฐะฝะฝัั...")
    collector = DataCollector()
    posts = await collector.collect_posts(client, CHANNEL, limit=10000)

    # 3. ะัะบะปััะฐะตะผ ะบะปะธะตะฝั ะฟะพัะปะต ัะฑะพัะฐ ะดะฐะฝะฝัั
    await client.disconnect()

    # 4. ะะตะฝะตัะธััะตะผ ะพัะฒะตัั
    print("๐ฏ ะญัะฐะฟ 3: ะะตะฝะตัะฐัะธั ะพัะฒะตัะพะฒ...")
    response_gen = ResponseGenerator()
    training_data = response_gen.generate_responses(posts)

    # 5. ะกะพััะฐะฝัะตะผ ะดะฐะฝะฝัะต
    with open('training_data.json', 'w', encoding='utf-8') as f:
        json.dump(training_data, f, ensure_ascii=False, indent=2)
    print(f"๐พ ะะฐะฝะฝัะต ัะพััะฐะฝะตะฝั ะฒ training_data.json ({len(training_data)} ะฟัะธะผะตัะพะฒ)")

    # 6. ะะฑััะฐะตะผ ะผะพะดะตะปั
    print("๐ ะญัะฐะฟ 4: ะะฑััะตะฝะธะต ะผะพะดะตะปะธ...")
    trainer = SimpleModelTrainer()
    training_texts = trainer.prepare_training_data(training_data)
    trainer.train(training_texts)

    print("๐ ะะฑััะตะฝะธะต ะทะฐะฒะตััะตะฝะพ! ะะพะดะตะปั ะณะพัะพะฒะฐ ะบ ะธัะฟะพะปัะทะพะฒะฐะฝะธั.")


if __name__ == "__main__":
    asyncio.run(main())
